<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="AnalyticDB 最佳实践, 网址的关键字，支持多个">
    <meta name="description" content="原文：ATA：https://ata.atatech.org/articles/11000164007?layout=%2Fvelocity%2Flayout%2Fblank.vm
各位亲爱的用户，随着AnalyticDB for MySQ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>AnalyticDB 最佳实践 | 记录、分享</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>

    <!-- Start: PlantUML -->
    <style type="text/css" rel="stylesheet">
      .plantuml-container {
        width: 100%;
        overflow: auto;
        text-align: center;
      }

      .plantuml-container > svg {
        max-width: 100%; height: unset !important;
      }

      .plantuml-container > img {
        max-width: 100%; height: unset !important;
      }
    </style>
    <!-- End: PlantUML -->
    </head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">记录、分享</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">记录、分享</div>
        <div class="logo-desc">
            
            记录一下的描述,主要用于SEO
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wanglikang" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wanglikang" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">AnalyticDB 最佳实践</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                <span class="chip bg-color">中间件</span>
                            </a>
                        
                            <a href="/tags/NewSQL/">
                                <span class="chip bg-color">NewSQL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">
                                中间件
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-09-01
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>原文：ATA：<a target="_blank" rel="noopener" href="https://ata.atatech.org/articles/11000164007?layout=%2Fvelocity%2Flayout%2Fblank.vm">https://ata.atatech.org/articles/11000164007?layout=%2Fvelocity%2Flayout%2Fblank.vm</a></p>
<p><strong><font style="color:rgba(25, 26, 31, 0.9);">各位亲爱的用户，随着AnalyticDB for MySQL（下文统一简称：ADB）在集团各个BU、社会上各行各业的推广应用，我们沉淀了一些最佳实践，现在笔者整理在这里，供大家参考，希望对大家有帮助。</font></strong></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">在读这篇文章之前，请先了解ADB的产品相关的文档：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">1.ADB</font><font style="color:rgba(25, 26, 31, 0.9);"> </font><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/92664.html?spm=5176.7937365.1120968.ee6.6f151f58LAgIPX">官方文档</a><font style="color:rgba(25, 26, 31, 0.9);">。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">2.集团内用户使用ADB过程中的</font><a target="_blank" rel="noopener" href="https://yuque.antfin-inc.com/dkysyp/egtkne">答疑手册</a><font style="color:rgba(25, 26, 31, 0.9);">。</font></p>
<p><strong><font style="color:rgba(25, 26, 31, 0.9);">说明：</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">本文写的最佳实践主要针对ADB3.0，ADB2.0在原理上同样适用，具体细节参考</font><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/97474.html?spm=a2c4g.11186623.6.908.5c1021c2RMeTIe">官方文档</a><font style="color:rgba(25, 26, 31, 0.9);">和我之前写的</font><a target="_blank" rel="noopener" href="https://www.atatech.org/articles/127932">ATA系列文章</a></p>
<h1><font style="color:rgba(25, 26, 31, 0.9);">通用最佳实践</font></h1>
<h2 id="font-style-color-rgba-25-26-31-0-9-表设计的最佳实践：-font"><font style="color:rgba(25, 26, 31, 0.9);">表设计的最佳实践：</font></h2>
<p><font style="color:rgba(25, 26, 31, 0.9);">ADB做为一个分布式的，追求实时分析海量数据的极致性能，需要充分发挥分布式数据库的优势，满足ADB达到最佳性能的特征要求，对表的设计时，需要注意以下几点规则。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-1-选择合适的表类型（维度表or普通表）：-font"><font style="color:rgba(25, 26, 31, 0.9);">1.选择合适的表类型（维度表or普通表）：</font></h4>
<p><strong><font style="color:rgba(25, 26, 31, 0.9);">维度表：</font></strong><font style="color:rgba(25, 26, 31, 0.9);">又称广播表，数据仓库中的一个概念，一般存储一些维度数据。在ADB中建表语句中有DISTRIBUTED BY BROADCAST 的关键字，这些表会在集群的每个节点存储一份数据，因此建议维度表的数据量不宜太大，每张维度表存储的数据不超过10万行。<br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">普通表：</font></strong><font style="color:rgba(25, 26, 31, 0.9);">也叫作分区表、事实表，一般存储业务的主题数据。普通表可存储的数据量通常比较大，可以存储千万条甚至万亿条数据，可以对其设置一级分区对数据做sharding或者二级分区进行数据的生命周期管理。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">注意：维度表如果太大会导致数据存储空间的膨胀，节点越多膨胀越大，同时也会导致实时写入时性能下降，iops会比较高。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-2-选择合适的分布键（一级分区键）：-font"><font style="color:rgba(25, 26, 31, 0.9);">2.选择合适的分布键（一级分区键）：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">ADB中创建普通表时，默认需要通过DISTRIBUTED BY HASH(column_name,…)指定分布键，按照column_name的HASH值进行分区。ADB支持将多个字段作为分布键。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">分布键的选择依据：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">尽可能选择参与JOIN的字段作为分布键，例如按照用户维度透视或者圈人，可以选择user_id作为分布键。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">尽可能选择值分布均匀的字段作为分布键，例如交易ID、设备ID、用户ID或者自增列作为分布键。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">注意：分布键不均匀容易导致数据分布不均，严重影响写入和查询的效率，此外也容易导致单节点磁盘写满导致整个集群锁定不可用。一般情况数据均匀是第一优先级，然后才考虑JOIN KEY对齐的问题，除非有业务就是想定制化。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-3-选择合适的分区键（二级分区键）：-font"><font style="color:rgba(25, 26, 31, 0.9);">3.选择合适的分区键（二级分区键）：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">如果业务明确有增量数据导入需求，创建普通表时可以同时指定分布键和分区，分区可以实现数据的增量同步。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">创建普通表时，通过PARTITION BY {VALUE(column_name) | VALUE(date_format(column_name, ?)}指定分区。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如，PARTITION BY VALUE(column_name)表示使用column_name的值来做分区，PARTITION BY VALUE(DATE_FORMAT(column_name, ‘%Y%m%d’))表示将column_name格式化为类似20190101的日期格式做分区。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 直接用ds的值来做分区<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">PARTITION BY VALUE(ds)<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- ds转换后的天做分区<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">PARTITION BY VALUE(DATE_FORMAT(ds, ‘%Y%m%d’))<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- ds转换后的月做分区<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">PARTITION BY VALUE(DATE_FORMAT(ds, ‘%Y%m’))<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- ds转换后的年做分区<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">PARTITION BY VALUE(DATE_FORMAT(ds, ‘%Y’))</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">注意：一个实例能承载的最大二级分区数目是有限的，当前限制是10240。请提前规划后这个实例的所有表二级分区键，尽量充分利用二级分区，不要让每个二级分区的数据量过小，如：你使用天做二级分区，但是每天数据量很小，这时可考虑用月来做二级分区。否则会导致数据库中需要保存分区数据的元数据特别多，这些元数据是需要存放在内存中，会占据内存较多的空间，容易导致系统的GC或者OOM，同时也会导致实时写入时的iops比较高</font></p>
<p><strong><font style="color:rgba(25, 26, 31, 0.9);">二级分区的过期策略</font></strong><font style="color:rgba(25, 26, 31, 0.9);">：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">目前二级分区过期策略是依据大小排序，只保留最大的N个二级分区，其中N为生命周期的大小。假设表A定义的生命周期个数为3，目前存在的二级分区为202001，202002，202003。当分区值为202004的数据写入进来时202001分区就会被淘汰。需要注意的是分区淘汰是延迟进行的，不保证202004的数据写入后立即会淘汰202001。此外在使用二级分区时也要注意脏数据带来的误淘汰问题，如果此时表A分别写入了分区值为300001,300002,300003的三条脏数据，那么分区淘汰策略也会被触发，整表将只剩下分区值最大的三条脏数据。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-4-选择合适的主键：-font"><font style="color:rgba(25, 26, 31, 0.9);">4.选择合适的主键：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">在表中定义主键可以去实现数据消重(Replace into)和数据更新操作(Delete、Update)。只有定义过主键的表支持数据更新操作（DELETE和UPDATE）。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">主键的选择依据：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 尽可能选择单数字类型字段作为主键，表的性能相对更好。ADB支持将字符串或者多字段组合作为主键。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 主键中必须包含分布键和分区键，如果有二级分区键的话，需要包含二级分区键。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">注意：设置的主键的字段不宜太大，或者某个字段的长度不宜过长，否则的话，会导致数据库的IOPS很高。</font><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">曾经某业务的主键设置太长：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264444750-d64240f8-8b6e-4546-b8db-e6ff3ac8deaf.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">导致在很多的tps下 iops特别高：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264444765-61dbea82-e017-4ce7-9816-84722637fe01.webp" alt=""></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-5-选择合适聚集索引：-font"><font style="color:rgba(25, 26, 31, 0.9);">5.选择合适聚集索引：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">聚集索引会将该列或者多列排序，保证该列相同或者相近的数据存在磁盘的相同或相近位置，当以聚集列做为查询条件时，查询结果保持在磁盘的相同位置，这样可以减少磁盘的IO。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">聚集索引的选择依据：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">查询一定会携带的字段可以作为聚集索引。例如，电商卖家透视平台中每个卖家只访问自己的数据，卖家ID可以定义为聚集索引，保证数据的局部性，提升数据查询性能。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">注意：目前聚集索引只支持一个，但该聚集索引可以有多列。目前除非对非常分散的数据进行点查，否则聚集索引对性能的帮助很少。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-6-设计合适的数据类型：-font"><font style="color:rgba(25, 26, 31, 0.9);">6.设计合适的数据类型：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">原理：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">ADB处理数值类型的性能远好于处理字符串类型。原因在于：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 数值类型定长，占用内存少，存储空间小。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 数值类型计算更快，尤其是join时。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 从内部索引机制上，字符串类型适合等值查询和范围查询情况，而时间，数值类型性能更高，建议用户尽可能- - 使用数值类型，减少使用字符串类型。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 选择尽可能小的列，列类型要尽可能选择匹配的列，比如性别就可以用boolean或者byte类型，数据长度不大的可以用int<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 在同一个业务模型内，相同字段设计成相同的数据类型和字段长度，字段命名也保持一致，特别是涉及到主外键关联的字段更要注意，避免表在关联时不同的数据类型的字段关联导致隐式转换。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">方法：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">常见将字符串转换为数值类型方法：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 包含字符前缀或后缀，例如E12345，E12346等。可以直接去掉前缀或者将前缀映射为数字。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 该列只有少数几个值，例如国家名。可以对每个国家编码，每个国家对应一个唯一数字。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 时间/日期类型数据，避免使用varchar字符类型存储，尽量使用date，timestamp或者int类型存储时间类型。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 对于地理经度维度的使用，需要通过地理函数查询情况，数据类型采用double数据类型。</font></p>
<h2 id="font-style-color-rgba-25-26-31-0-9-数据写入方面的最佳实践-font"><font style="color:rgba(25, 26, 31, 0.9);">数据写入方面的最佳实践</font></h2>
<h3 id="font-style-color-rgba-25-26-31-0-9-实时写入：-font"><font style="color:rgba(25, 26, 31, 0.9);">实时写入：</font></h3>
<h4 id="font-style-color-rgba-25-26-31-0-9-1-批量打包的方式提交：-font"><font style="color:rgba(25, 26, 31, 0.9);">1.批量打包的方式提交：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">向表中写入数据时，可以通过批量打包方式INSERT INTO和REPLACE INTO提高数据写入性能。建议如下：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 通过每条INSERT或者REPLACE语句写入的数据行数大于1000行，但写入的总数据量不宜太大，不要超过16MB。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 通过批量打包方式写入数据时，单个批次的写入延迟相对会高一些，但是整体的性能会提升。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 写入报错时，需要做重试确保数据被写入，重试导致的数据重复可以通过表的主键来消除。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 如果不需要对原始的数据进行修改，直接使用insert into比replace into效率会高3倍以上。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">样例：</font></p>
<pre><code class="language-plain">INSERT INTO  test
(id, name,sex,age,login_time) 
values
(1,'dcs',0,23,'2018-03-02 10:00:00'),
(2,'hl',0,23,'2018-03-02 10:01:00'),
(3,'xx',0,23,'2018-03-02 10:02:00')
......;
</code></pre>
<h4 id="font-style-color-rgba-25-26-31-0-9-2-更新数据-font"><font style="color:rgba(25, 26, 31, 0.9);">2.更新数据</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">数据更新有多种方式，使用区别如下：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 高频基于主键的行级覆盖更新, 且应用可以补齐所有列，请使用replace into values批量打包<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 高频基于主键的行级覆盖更新, 应用不能补齐所有列，请使用update into values批量打包<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 低频基于主键更新，可以使用replace into或者update into单条数据<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 低频任意条件更新，请使用 update set where<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">注意：update需要查表来填补更新中缺失的旧值，因此比replace into多一次查询，性能较低，不建议做高频、大批量的update操作。如果线上update性能无法满足需求，需考虑替换成Replace into，由应用端补旧值。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-3-删除数据-font"><font style="color:rgba(25, 26, 31, 0.9);">3.删除数据</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">数据删除有多种方式，使用区别如下：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 低频主键条件删除，请使用 delete from where pk = xxx<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 低频任意条件删除，请使用 delete from where<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 删除单个二级分区，请使用 truncate partition<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 删除单表（包括所有二级分区，如有），请使用truncate table或drop table</font></p>
<h3 id="font-style-color-rgba-25-26-31-0-9-批量导入：-font"><font style="color:rgba(25, 26, 31, 0.9);">批量导入：</font></h3>
<h5 id="font-style-color-rgba-25-26-31-0-9-如何选择是批量导入还是实时导入-font"><font style="color:rgba(25, 26, 31, 0.9);">如何选择是批量导入还是实时导入</font></h5>
<ul>
<li><font style="color:rgba(25, 26, 31, 0.9);">从ODPS、OSS导入ADB，推荐使用insert overwrite select做批量导入，原因有二：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">一方面，批量导入适合大数据量导入，性能好<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">二方面，批量导入适合数仓语义，即导入过程中旧数据可查，导入完成一键切换新数据。如果导入失败，新数据会回滚，不影响旧数据的查询。</font></li>
<li><font style="color:rgba(25, 26, 31, 0.9);">从RDS、MySQL、ADB等导入ADB，看数据量情况，数据量不大的(百万级别的表)，推荐使用insert into select做实时导入，数据量大的，推荐使用insert overwrite select做批量导入。</font></li>
</ul>
<h5 id="font-style-color-rgba-25-26-31-0-9-导入并发和资源说明-font"><font style="color:rgba(25, 26, 31, 0.9);">导入并发和资源说明</font></h5>
<ul>
<li><font style="color:rgba(25, 26, 31, 0.9);">单张表的导入会在系统内部串行，不同表之间的导入任务会并行，默认并行度是2；从ODPS分区表导入到ADB时，每次导入横跨的分区数不要超过30个，同一张表的不同分区导入是排队串行，不同表的导入，同时提交，有并行度n个任务同时导入，出于资源控制，超出的任务也会排队。</font></li>
<li><font style="color:rgba(25, 26, 31, 0.9);">导入使用的是ADB内部的资源，与查询一样，属于同一个实例的资源。推荐导入任务在查询qps比较低的时候进行，比如凌晨0点以后，并推荐用户配置d2等定时任务，错峰做导入。</font></li>
</ul>
<h2 id="font-style-color-rgba-25-26-31-0-9-高效查询的最佳实践-font"><font style="color:rgba(25, 26, 31, 0.9);">高效查询的最佳实践</font></h2>
<p><font style="color:rgba(25, 26, 31, 0.9);">ADB的优势是能在海量数据场景下，面对复杂查询，做到实时的在线分析。ADB的SQL调优需要充分发挥分布式计算优势，以及ADB本身的一些特征，同时对于通用的数据库优化的方法论同样是适用。</font></p>
<h3 id="font-style-color-rgba-25-26-31-0-9-查询优化的通用法则：-font"><font style="color:rgba(25, 26, 31, 0.9);">查询优化的通用法则：</font></h3>
<p><font style="color:rgba(25, 26, 31, 0.9);">按照斗佛早些年在《ORACLE DBA手记》上写的文章，数据访问优化满足以下漏斗法则：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264444751-33ec5c5f-f54c-4dab-a89c-f6a3dfba42f6.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">1、 减少数据访问（减少磁盘访问）</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如：尽量多的使用过滤条件，尽早的提前过滤数据，减少参与计算的数据量，能在子查询里面把数据先过滤的提前过滤。<br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">2、 返回更少数据（减少网络传输或磁盘访问）</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如：避免select * 的查询，特别的在OLAP数据库下，往往表的列数比较多，同时由于基于列存或者行列混存，对于这种select * 的操作，需要请求的IO回更多。<br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">3、 减少交互次数（减少网络传输）</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如：上文提到的批量提交。<br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">4、 减少服务器CPU开销（减少CPU及内存开销）</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">A. 减少不必要的排序和分页，特别是在子查询中的排序<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">B. 在满足业务前提下，尽量减少count distinct操作<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">C. 在满足业务前提下，特别是在海量数据下，采用类似Hyperloglog的近似计算代替准确计算。<br>
</font><strong><font style="color:rgba(25, 26, 31, 0.9);">5、 利用更多资源（增加资源）</font></strong><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">例如：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">A. 设计表的时候，尽量避免分区倾斜，导致存储和计算压在某一个节点上，尽量把数据都均匀的散列到所有的节点上，充分利用所有机器的能力，最大发挥分布式的数据库的效能<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">B. ADB本身就是MPP大规模并行处理的典型系统，在内核层面也做了大量的优化处理，充分利用更多的资源。</font></p>
<h3 id="font-style-color-rgba-25-26-31-0-9-ADB特殊场景的优化：-font"><font style="color:rgba(25, 26, 31, 0.9);">ADB特殊场景的优化：</font></h3>
<h5 id="font-style-color-rgba-25-26-31-0-9-外表的查询最佳实践-font"><font style="color:rgba(25, 26, 31, 0.9);">外表的查询最佳实践</font></h5>
<p><font style="color:rgba(25, 26, 31, 0.9);">不要尝试对外表进行较为复杂的计算，这样会导致比较严重的GC，因为外表的计算是全部把数据拖过来算的，且网络带宽的压力也会变大。</font></p>
<h5 id="font-style-color-rgba-25-26-31-0-9-巧妙的使用聚集索引：-font"><font style="color:rgba(25, 26, 31, 0.9);">巧妙的使用聚集索引：</font></h5>
<p><font style="color:rgba(25, 26, 31, 0.9);">当查询条件一定包含某列时，特别是该列的数据在存储上非常分散时，对该列建立聚集索引，性能会有明显的提升，可以采用类似如下的sql语句添加聚集索引：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">alter table table_name ADD CLUSTERED INDEX index_cls (d_fdbid);<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">注意：如果表里面的数据已经有了，直接add cluster index不会对存量的数据排序，需要重建表，在建表的时候加上聚集列关键字。</font></p>
<h5 id="font-style-color-rgba-25-26-31-0-9-减少节点间的数据交互：-font"><font style="color:rgba(25, 26, 31, 0.9);">减少节点间的数据交互：</font></h5>
<p><font style="color:rgba(25, 26, 31, 0.9);">分布式数据库，在充分发挥分布式计算的同时，有时也会加大跨节点间的网络开销，特别是请求的数据散列在各个节点上时，请求的数据量有比较少，且节点个数又比较多情况下，跨网络开销的情况就非常明显，因此可以采用以下几个思路：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 如果能采用本地计算，在各个节点内join或者聚合分析时，尽量在本节点内计算，具体做法就是，如果在满足业务前提下，能用户一级分区键关联的，采用一级分区键关联；能对一级分区键进行group by的，采用一级分区键group by，这样可以尽量采用localjoin，大大减少跨网络的访问。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 合理的控制节点数量，并不是节点越多越好，当数据库规模不大，且每次查询的数据量很少，且跨网络访问很严重的情况下，节点越多，问题越严重。</font></p>
<h5 id="font-style-color-rgba-25-26-31-0-9-合理的使用索引：-font"><font style="color:rgba(25, 26, 31, 0.9);">合理的使用索引：</font></h5>
<p><font style="color:rgba(25, 26, 31, 0.9);">合理使用索引在数据库调优中，非常重要，在ADB中也不例外。在ADB中，默认每列都会创建索引。但是也有例外情况，如果某列的cardinality值比较少时，通过索引查询可能会更慢，因为他需要多查一次索引再回表，且索引的选择性又不高，性能就会很差，这时可以在建表时把这些disable掉建索引的功能，这样就不会在建表后自动建索引了，如果索引已经创建了，可以把索引删除掉，或者通过hint 不走索引访问：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">alter table table_name drop index index_name 把枚举列的索引删除掉。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">或者使用/</font><em><font style="color:rgba(25, 26, 31, 0.9);">+no_index_columns=[t_order_content.fdelete;fdbid]</font></em><font style="color:rgba(25, 26, 31, 0.9);">/ 类似这样的hint把索引去掉不走</font></p>
<h2 id="font-style-color-rgba-25-26-31-0-9-ADB连接的最佳实践-font"><font style="color:rgba(25, 26, 31, 0.9);">ADB连接的最佳实践</font></h2>
<p><font style="color:rgba(25, 26, 31, 0.9);">ADB在使用方式上做到和99%以上和mysql兼容，支持多种连接方式，比如mysql命令行，JDBC连接，Python连接，c#连接，PHP连接等等。整体请参考</font><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/123738.html?spm=a2c4g.11186623.6.591.50445923JhLCF3">官方文档</a><font style="color:rgba(25, 26, 31, 0.9);"> </font><font style="color:rgba(25, 26, 31, 0.9);">。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">另补充Golang连接最佳实践：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">分析型数据库MySQL版3.0 Golang最佳实践：</font><a target="_blank" rel="noopener" href="https://yuque.antfin-inc.com/docs/share/d29e0153-df52-44ac-b5eb-430561325da6?#">请参考</a><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">分析型数据库MySQL版2.0 Golang最佳实践：</font><a target="_blank" rel="noopener" href="https://yuque.antfin-inc.com/docs/share/bc440e24-4338-40b5-be09-91fcce0807d1?#">请参考</a><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">注意：由于ADB已经是一个分布式数据库，不需要再通过TDDL中间件来连接ADB。</font></p>
<h1><font style="color:rgba(25, 26, 31, 0.9);">业务行业线上的最佳实践参考：</font></h1>
<h2 id="font-style-color-rgba-25-26-31-0-9-客户运营行业-font"><font style="color:rgba(25, 26, 31, 0.9);">客户运营行业</font></h2>
<h4 id="font-style-color-rgba-25-26-31-0-9-客户运营行业使用场景：-font"><font style="color:rgba(25, 26, 31, 0.9);">客户运营行业使用场景：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">随着互联网流量成本的增加，花大价钱砸流量的时代成为历史，客户广告营销越来越讲究精细化运营，越来越依赖对已有的客户数据做实时的，精准的分析，提高广告的转化率，在对人群的营销方面一般存在以下典型的场景：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264444768-4f764d7c-48b8-4ad0-900b-b5f08a10827e.webp" alt=""></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">典型的系统架构：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264444759-5d07a101-4d2a-447f-bc59-5659527379c3.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">核心表建表语句如下：</font></p>
<pre><code class="language-plain">CREATE TABLE db.order (
order_id,
user_id,
shop_vip,
last_trade_time,
last_cart_time,
member_grade,
seller_zone,
member_credits,
clustered key index_mmsi(`user_id`)
)
DISTRIBUTED BY HASH(order_id)
PARTITION BY VALUE(DATE_FORMAT(last_trade_time, '%Y%m%d')) LIFECYCLE 30
COMMENT '订单信息表';
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">备注：采用order_id做为分布键，确保数据均匀分布，不会出现倾斜，同时由于需要频繁的按照user_id查询或者关联，可以将user_id建为聚集索引。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">（1）人群透视<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">人群透视是指的根据用户的各种标签，来选取特定的人群。通常情况下，以用户或者用户行为的表做为一张事实表，用户的各类标签/属性做为维度表，采用星型模型，用事实表来join各个维度表，做多维分析（有时也可能会采用数据冗余的反范式方式，以牺牲数据存储为代价，将事实表构建为一张大宽表，目的是省去分析时的多表关联）。正是因为用户分析标签的不确定性，采用传统的数据（传统数据库的索引是不能无限制的创建的）是无法做到这种不定维度的分析的，那么ADB就是解决该类问题的最佳方案。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">典型的SQL如下：</font></p>
<pre><code class="language-plain">SELECT
  t2.buyer_id,
  t3.seller_id,
  t1.shop_vip,
  t1.last_trade_time,
  t1.last_cart_time,
  t1.member_grade,
  t1.seller_zone,
  t1.member_credits,
  sum(t1.pay_amount)
FROM
  db.order t1
  JOIN db.dimension_table1 t2 ON t1.user_id= t2.buyer_id
  JOIN db.dimension_table2 t3 ON t1.user_id= t3.seller_id
WHERE
  t1.is_market_target IN('4')
  AND t1.seller_zone = 1019
  AND t1.attributes IN('6742081')
  AND t3.buyer_id = ‘xxxx’
  and t3.tseller_id = ‘yyyy’
group by
  t2.buyer_id,
  t3.seller_id,
  t1.shop_vip,
  t1.last_trade_time,
  t1.last_cart_time,
  t1.member_grade,
  t1.seller_zone,
  t1.member_credits
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">其中的order表可能是万亿级别，巨量数据的多维、多表关联在线实时分析对底层分析系统的能力要求极高。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">（2）人群圈选<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">人群圈选场景和人群透视的场景类似，更多的时候可能是圈选具体的人群数量，而不是具体的明细数据，这时更多的时候是使用到ADB的聚合计算的能力，即根据各个不定的维度进行count distinct或者group by的操作。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">典型的SQL语句如下：</font></p>
<pre><code class="language-plain">SELECT count(1) AS cnt
  FROM(
SELECT DISTINCT t1.buyer_id
  FROM(
SELECT buyer_id
  FROM db.order
 WHERE seller_zone= 11111
   AND seller_id= 121211121
   AND algorithm_crowd IN('84')) t1 
 JOIN(
SELECT user_id AS buyer_id
  FROM db.dimension_table1) t2 
      ON t1.buyer_id= t2.buyer_id
JOIN(
SELECT user_id AS seller_id
  FROM db.dimension_table2) t3 
      ON t1.buyer_id= t3.seller_id
) t
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">（3） 人群投放<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">是指将上面圈选的人群，按照一定的促销渠道投放去处。比如用短信投放，那么就将相关的用户信息取出来投放到运营商渠道；比如投放到一些门户网站，那么就投放到一些广告公司。不同的渠道的数据可以使用不同OSS来存放，而ADB支持将库内的数据，很方便的dump到oss或者其他的下游产品上，而且dump的效率也非常的高效。很好的节省了用户人群投放的效率。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">典型的sql如下：</font></p>
<pre><code class="language-plain">CREATE TABLE output with(oss_dump_endpoint= 'xxxxxx.oss-internal.aliyun-inc.com', oss_dump_bucket_name= 'xxxx', 
                         oss_dump_file_name= 'xx_prod/20190710/63218721', 
                         oss_dump_is_overwrite= true, 
                         oss_dump_compatibility_mode= false, 
                         oss_dump_access_key_id= 'xxxxxxxxx', 
                         oss_dump_access_key_secret= 'xxxxxxxxxxxxxxxxxxxx', 
                         oss_dump_row_del= '\r\n', 
                         oss_dump_col_del= '\t', table_type= 'oss_dump', dump_charset_code= 'UTF-8', 
                         oss_dump_table_header= 'false', return_dump_result_count= true) as
SELECT DISTINCT t1.buyer_id
  FROM(
SELECT buyer_id
  FROM db.order
 WHERE last_cart_time&gt;= 20190610
   AND last_cart_time&lt; 20190710
   AND is_market_target IN('1')
   AND seller_zone= 1018
   AND seller_id= 3687815378) t1 
JOIN(
SELECT user_id AS buyer_id
  FROM db.dimension_table) t2 
ON t1.buyer_id= t2.buyer_id 
LIMIT 10000
</code></pre>
<h2 id="font-style-color-rgba-25-26-31-0-9-监控大屏类：-font"><font style="color:rgba(25, 26, 31, 0.9);">监控大屏类：</font></h2>
<p><font style="color:rgba(25, 26, 31, 0.9);">由于ADB支持实时写入，而且实时写入的数据又能进行比较复杂的实时分析，因此在一些监控大屏，监控大盘，实时看板等应用场景中也使用的非常广泛。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">典型的系统架构如下：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264445173-4b011e50-0d61-47fd-9d3b-a3855b275161.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">上游生产数据通过Blink、DTS、精卫或者dataworks等工具实时写入到ADB中，在ADB中进行实时在线分析，然后在报表展现工具做大屏显示。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">对于该类的业务，对数据的时效要求很高，特别是对数据的实时写入要求很高，实时写入的数据量大，且要求写入后实时可见，还要能快速的分析，因此在表的设计时要特别注意这方面的需求，需要注意以下几点：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 表设计时要设置主键：主键用于排重，一旦有重复的数据写入可以直接覆盖，具体主键设计的细则参考上文；<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 表的设计要设计二级分区：一来该类数据往往量比较大，需要采用二级分区做数据的生命周期管理，自动淘汰过期的数据；二是实时写入数据的索引的构建可以根据二级分区来构建，这样只需要增量数据构建索引，大大提高构建索引的效率，而不需对全表构建索引，有了索引后，数据的查询也就能快很多。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 在特别大量的写入情况下，往往cpu的消耗也比较厉害，需要合理控制构建索引任务的并发度和时间，以避免和大流量写入峰值重合，而加深对实时写入的影响。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">典型的SQL如下：</font></p>
<pre><code class="language-plain">Create Table tb__record_info
(
  a_info_id bigint NOT NULL AUTO_INCREMENT,
  domain varchar NOT NULL,
  region varchar NOT NULL,
  ip varchar NOT NULL,
  result_ts varchar NOT NULL,
  time_stamp timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  key idx_domain(domain),
  key idx_time(time_stamp),
  primary key (a_info_id, domain, time_stamp)
) DISTRIBUTE BY HASH(domain) 
PARTITION BY VALUE(DATE_FORMAT(time_stamp,'%Y%m%d')) LIFECYCLE 60
</code></pre>
<h2 id="font-style-color-rgba-25-26-31-0-9-游戏行业：-font"><font style="color:rgba(25, 26, 31, 0.9);">游戏行业：</font></h2>
<h4 id="font-style-color-rgba-25-26-31-0-9-ADB在游戏行业的使用场景：-font"><font style="color:rgba(25, 26, 31, 0.9);">ADB在游戏行业的使用场景：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">游戏领域的竞争变得更加激烈，在互联网高速增长的同时，流量成本不断升高，市场营销开始往精细化发展。游戏厂商对于渠道、用户和游戏表现的评估需要更加细化和准确的数据的要求，希望利用优秀的数据分析工具来帮助团队更全面的分析市场和用户的趋势，同时玩家的游戏行为和喜好也在慢慢变化，如何能够及时发现这些变化并针对性的调整产品和游戏设计也是非常重要的，因此提出了如下业务要求：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 提供全面的游戏运营指标分析功能：全面提高游戏开发者的日常数据运营工作效率，不仅提供付费用户、付费率、付费金额和ARPU等运营指标，还强化了付费用户的留存率、回访率、用户生命周期价值等更加精细化的运营指标，游戏开发者可以更加深入，更加有效率的掌握游戏运营状态。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 提供有效分析渠道效果，使每分钱都花在刀刃上：实时的分渠道数据统计可以监测到不同渠道用户的增长、活跃、留存状况以及充值状况，更加全面、快速的分析出投资回报率，让开发者对渠道的评估更加准确。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 针对对付费用户追踪分析，了解付费用户的习惯：针对付费用户群，通过简单易懂的数据分析模型和图表，跟踪付费用户的留存、流失、回访和充值数据，更好的反映付费用户在整个生命周期的关键行为和价值。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 细致分析玩家游戏行为，改进产品体验，提高游戏收益：关卡、道具、消费行为分析的功能可以了解道具和物品在使用过程中使用和消耗的总量以及趋势，开发者可以借此来做到恰到好处的数值平衡设计，也可充分利用数据分析的结果来帮助开发者优化游戏内付费商品的收益。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-典型场景的查询SQL：-font"><font style="color:rgba(25, 26, 31, 0.9);">典型场景的查询SQL：</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">（1）活跃分析<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">游戏产品日活DAU/月活MAU等均为评价该款游戏是否被玩家广泛接受的一个非常重要的指标，如下：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264445232-8b954199-7086-41c3-a896-8c48ae97a786.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">如此类DAU计算的SQL示例通常如下：</font></p>
<pre><code class="language-plain">SELECT count(DISTINCT uid) AS count 
FROM login_log 
WHERE timestamp &gt;= &lt;start_timestamp&gt; 
AND timestamp   &lt;= &lt;end_timestamp&gt; 
AND qita1        = &lt;x&gt; 
AND qita2        = &lt;y&gt;;
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">基于上述的基本统计，可以对玩家的活跃状态做更多的探索，比如：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 活跃账号分析：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 按照日期分析，常见的DAU/WAU/MAU等<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 按照渠道分析，比如如分包渠道或者广告渠道等<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 在线分析：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 平均在线玩家数<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 峰值在线玩家数<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 玩家行为分析：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 人均游戏次数，所选日期内，总游戏次数 / 游戏人数（该数值无法完全精确统计，仅供参考）<br>
</font><font style="color:rgba(25, 26, 31, 0.9);"> 人均游戏时长分析等</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">（2）来源分析<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">游戏玩家来源分析里面，新增设备分析用来预测该款游戏的生命周期和拉新效率等，均为评价该款游戏是否被玩家广泛接受的一个非常重要的指标，如下：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264445171-eb7e0719-dc06-43d8-b2ab-a8913e02dec4.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">如此统计新增设备、新增玩家等计算的SQL示例通常如下：</font></p>
<pre><code class="language-plain">SELECT Count(*) AS count  FROM  
 (
    SELECT deviceid
    from login_log          
    WHERE  channel_id = ‘X’                 
    AND timestamp &gt;= ‘XXX’
    AND timestamp &lt;= ‘YYY’
    GROUP  BY deviceid
) AS d1
    LEFT JOIN 
(
    SELECT deviceid                    
    FROM   login_log                    
    WHERE  channel_id = ‘X’                            
    AND timestamp &lt; ‘YYY’
) AS d2
ON d1.deviceid = d2.deviceid  
WHERE  d1.deviceid IS NULL;
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">（3）留存分析<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">留存指标在某些方面反映了游戏产品的质量和保留玩家的能力，也在另一方面反映了渠道与游戏目标用户的契合度及渠道质量。所以对留存指标的分析显得更为重要，如下：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264445196-d8bbc9e8-a7f0-4f97-b515-232348c90ea6.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">如此统计玩家留存率等计算的SQL示例通常如下：</font></p>
<pre><code class="language-plain">SELECT
  channel_id,
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 0,
      user_id,
      NULL
    )
  ) AS 'liucun_1',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 1,
      user_id,
      NULL
    )
  ) AS 'liucun_2',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 2,
      user_id,
      NULL
    )
  ) AS 'liucun_3',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 3,
      user_id,
      NULL
    )
  ) AS 'liucun_4',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 4,
      user_id,
      NULL
    )
  ) AS 'liucun_5',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 5,
      user_id,
      NULL
    )
  ) AS 'liucun_6',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 6,
      user_id,
NULL
    )
  ) AS 'liucun_7',
  count(
    DISTINCT IF (
      datediff(payorder_riqi, login_riqi) = 14,
      user_id,
      NULL
    )
  ) AS 'liucun_15'
FROM
  pay_order p
  LEFT JOIN login_log l ON p.uid = l.uid
WHERE
  payorder_riqi &gt;= '2019-01-17'
  AND payorder_riqi &lt;= '2019-01-24'
GROUP BY
  `channel_id`
ORDER BY
  `liucun_1` DESC
</code></pre>
<h2 id="font-style-color-rgba-25-26-31-0-9-交通行业-font"><font style="color:rgba(25, 26, 31, 0.9);">交通行业:</font></h2>
<p><font style="color:rgba(25, 26, 31, 0.9);">随着全国开始推广取消跨省收费站，原来的各个省各自为政的线下收费搬到了线上，这些信息化系统的建设，一方面大大的提高了收费和通行的效率，同时也为国家打通全国收费一盘棋，深化高速公路收费体系改革，降低中国流通成本提供了数据基础；另一方面，国家相关部门依赖这些数据，进行一些更加精准的分析，又能进一步推动交通行业的发展。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-几个典型的应用场景-font"><font style="color:rgba(25, 26, 31, 0.9);">几个典型的应用场景</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">（1）车辆通行查询<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">全国高速公路取消跨省收费站后，所有的车辆经过龙门架后，自动计费。全国1.9亿的ETC，和25万的龙门架，针对这些海量龙门架数据和ETC数据做统计查询，既要保证能存的下，还要要查的快，算的准，这时选用ADB是一个很好的选择方案，既能满足按照门架id、车牌号等任意维度的统计分析，还能满足存储下这些海量的数据，做到比较弹性的扩展。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">通常表和数据库的设计要注意如下几点：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 保证表的数据在各个节点分布均匀，不能将门架号做为分布键，因为在有些区域的车流量特别大，对应的门架的数据量会比较大，有些经济欠发达地区，车流量很少，门架的车流数据很少，这样会导致很严重的数据倾斜。可以考虑把把ETCID 或者车牌号做为分布键，将门架id设计为聚集索引。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">- 由于要满足海量的数据实时写入，在建表和数据库调优时要充分考虑数据实时写入的性能，设计的主键不宜太长，构建索引的频率选择一个合适的平衡点，最好和实时写入峰值的时间错开等等。</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">（2）数据稽核<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">作为智慧高速的一部分，既要提供车流实时分析、通行费用结算、智能交互等多样的应用服务，又要加强高速管理，对偷逃费等行为具备智能稽核的能力。在稽核业务中，关于可疑车辆的行驶轨迹查询是非常常见的场景，可是关于可疑车辆的信息描述则可能非常的模糊，比如“车牌尾号是“NV0”的车辆”。如果只是使用倒排索引，车牌 like ‘%NV0’这种查询条件不可避免的会触发全表扫描，在数据量这么巨大的场景下，全表扫描的代价是十分巨大的。如果对车牌字段构建全文索引，返回结果中又会包含很多‘NV0’不在末尾的车牌信息。最佳的解决方案是在表结构中冗余一个车牌字段，并将它创建全文索引，同时使用这两个字段作为查询条件：先用match(车牌_2) against (’“NV0”')筛选出所有包含NV0的车牌信息，在此基础上，再用车牌_1 like '%NV0’筛选出NV0在结尾的车牌。（注释：车牌_1和车牌_2均存储车牌信息，为车牌_1构建倒排索引，车牌_2构建全文索引）。</font></p>
<pre><code class="language-plain">select  * from demo where match(licence_code2) against ('"NV0"')  and licence_code like '%NV0';
</code></pre>
<p><font style="color:rgba(25, 26, 31, 0.9);">（3）数据分发<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">在有些专有云场景下，由于不同的ISV，不同的部门对数据有着不同的需求和访问权限，甲方的数据资产部门不可能把核心的数据仓库（基于ADB构建的实时数仓）全部开放给需求方，即使可以用子账号的方式开放，但是对于一些不同网络环境的部门的数据需求就无法满足，在这种场景下，可以使用ADB的dump能力把实时数仓的数据dump到不同的需求方的oss的bucket里面，需求方根据约定的规则到oss上取数据。具体架构如下：<br>
</font><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/webp/308915/1709264445219-d302bbab-b375-4613-9aa2-c9914bbe268a.webp" alt=""><font style="color:rgba(25, 26, 31, 0.9);"><br>
</font><font style="color:rgba(25, 26, 31, 0.9);">这样的应用，ADB在满足实时数仓的高效分析的同时，还起到了数据分发HUB的作用，让数据资产部门能很好的掌控数据。</font></p>
<h1><font style="color:rgba(25, 26, 31, 0.9);">FAQ:</font></h1>
<h4 id="font-style-color-rgba-25-26-31-0-9-1-磁盘占用大小包含哪些数据？为什么会触发磁盘满锁定？-font"><font style="color:rgba(25, 26, 31, 0.9);">1. 磁盘占用大小包含哪些数据？为什么会触发磁盘满锁定？</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">磁盘占用量主要包括数据和索引两部分。索引在构建过程中，会临时额外占用少量空间，期间可能会有少量数据膨胀。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">用户可以使用如下sql查询使用空间：（延迟统计的，1小时统计一次）<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">select (sum(data_length)+sum(index_length))/1024/1024/1024 as ‘数据空间(GB)’ from information_schema.tables;<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">使用如下sql查询当前日志使用空间：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">show binary logs<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">其中，adb-bin.log表示binlog，adb-system.log表示系统日志。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">单节点磁盘使用量超过80%则会触发锁定，有2种可能原因：一是一级分区键选择不合理导致某些节点数据倾斜，二是数据分布比较平均，总体使用量过大。是否存在表有分区倾斜可以在控制台页面观察。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-2-是否支持磁盘大小扩缩，是否支持节点数扩缩？节点数扩缩需要多久-font"><font style="color:rgba(25, 26, 31, 0.9);">2. 是否支持磁盘大小扩缩，是否支持节点数扩缩？节点数扩缩需要多久?</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">目前磁盘使用ecs云盘，只支持扩容，不支持缩容。节点数支持扩缩，数量范围与实例初始规格相关，控制台变配页面可以看到当前实例节点数变配范围。节点数扩缩会在节点间进行部分数据迁移，正常情况下最大耗时为最大单节点磁盘使用量/40(MB/s) + 20min。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-3-如何进一步提高写入性能？-font"><font style="color:rgba(25, 26, 31, 0.9);">3. 如何进一步提高写入性能？</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">数据写和导入尽可能使用批量写入的方式，使用dataworks进行数据同步可关注是否并发任务数和写入批大小设置过小。主键选择尽可能精简。写入表的分区键选择尽可能均衡。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-4-如何选择合适的一级分区列-font"><font style="color:rgba(25, 26, 31, 0.9);">4. 如何选择合适的一级分区列</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">ADB内部将数据拆分为若干个一级分区，通常情况下一个ADB实例内部大概有100数量级左右的一级分区。在进行查询时不同的一级分区并发进行。因此一级分区列最重要的一点是需要保证数据尽可能的均匀，否则会出现长尾查询拖慢整体查询进度。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">不同的表如果一级分区列相同，那么这些表在执行以一级分区列为join key的join时可以大幅度减少数据shuffle。因此在保证数据均匀的前提下，相同的一级分区列可以加速join。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-5-如何选择合适的二级分区列-font"><font style="color:rgba(25, 26, 31, 0.9);">5. 如何选择合适的二级分区列</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">二级分区是对一级分区的进一步拆分，一般是在时间维度上进行。大部分情况下单二级分区的数据尽量超过一百万，达到百万级，同时也不要达到数千万。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">下面以一张订单表为例来选择合适的二级分区。假设这张表单天增量百万左右，需要保留10年的数据。由于我们单ADB集群通常情况下，有100左右的一级分区。若该表按日为分区，则单二级分区的大小约为1w左右远低于我们的建议值。因此用月或者年作为二级分区比较合适。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">二级分区的生命周期是支持修改的。如下语句: alter table lineitem partitions 12展示了如何将lineitem的二级分区个数修改为12。需要注意的是二级分区个数的修改是后台异步执行的，执行build table lineitem可以加速分区修改任务。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-6-二级分区的过期策略是怎样的。-font"><font style="color:rgba(25, 26, 31, 0.9);">6. 二级分区的过期策略是怎样的。</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">目前二级分区过期策略是依据大小排序，只保留最大的N个二级分区，其中N为生命周期的大小。假设表A定义的生命周期个数为3，目前存在的二级分区为202001，202002，202003。当分区值为20204的数据写入进来时202001分区就会被淘汰。需要注意的是分区淘汰是延迟进行的，不保证20204的数据写入后立即会淘汰202001。此外在使用二级分区时也要注意脏数据带来的误淘汰问题，如果此时表A分别写入了分区值为300001,300002,300003的三条脏数据，那么分区淘汰策略也会被触发，整表将只剩下分区值最大的三条脏数据。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-7-聚集索引是什么，什么情况下适合使用聚集索引。-font"><font style="color:rgba(25, 26, 31, 0.9);">7. 聚集索引是什么，什么情况下适合使用聚集索引。</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">聚集索引就是让数据根据若干字段进行排序。对于有这相同的排序字段的数据在物理上尽可能的存储在一起。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">如果查询一定会带的某个字段，比如电商中卖家透视平台，每个卖家只访问自己的数据，那卖家id就是可以选择为聚集索引，可以保证数据的locality，进而性能有量级的提升。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">目前聚集索引只支持一个，但该聚集索引可以有多列。目前除非对非常分散的数据进行点查，否则聚集索引对性能的帮助很少，请谨慎选择。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-8-主键如何选择，是否能够修改主键？-font"><font style="color:rgba(25, 26, 31, 0.9);">8. 主键如何选择，是否能够修改主键？</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">主键一般情况下用于数据的去重。主键的长度与去重的效率成反比，因此非常不建议使用较长的String如UUID作为主键，建议为1~3个long值。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">此外需要注意的是，主键需要包含一级分区键和二级分区键。目前不支持主键的修改。</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-9-如何自己指定索引-font"><font style="color:rgba(25, 26, 31, 0.9);">9. 如何自己指定索引</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">a. ADB默认是全字段索引，一般不需要自己维护索引。<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">b. 如何查看一个表有哪些索引，跟mysql一样使用这个语句：show index from t<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">c. 如果想要drop掉某个索引可以使用：alter table t drop key key_name。其中key_name可以通过上面的语句查询。注意drop掉索引会导致查询变慢<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">d. 如果想要自己指定索引，那跟mysql一样，使用key关键字：key key_name (column_name)。如：create table t(id bigint,c1 varchar,key id_idx(id))DISTRIBUTE BY HASH(id)</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-10-直接用mysql的建表ddl可以在adb中执行建表吗？-font"><font style="color:rgba(25, 26, 31, 0.9);">10. 直接用mysql的建表ddl可以在adb中执行建表吗？</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">可以的，具体行为是这样的：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 如果DDL中有主键，用主键做distribute key<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">• 如果DDL中没有主键，会自动给他添加一个字段：<strong>adb_auto_id</strong>，然后用__adb_auto_id__做主键和分区键</font></p>
<h4 id="font-style-color-rgba-25-26-31-0-9-11-可以直接用adb2-0的建表语句在adb3-0中执行吗？-font"><font style="color:rgba(25, 26, 31, 0.9);">11. 可以直接用adb2.0的建表语句在adb3.0中执行吗？</font></h4>
<p><font style="color:rgba(25, 26, 31, 0.9);">可以</font></p>
<p><font style="color:rgba(25, 26, 31, 0.9);">参考文档：<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">李华植：《海量数据库解决方案》<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">白鳝 ：《DBA的思想天空》<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">叶正盛：《面向程序员的数据库访问性能优化法则》<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">南靖：《新一代游戏数据运营融合分析最佳实践V2.docx》<br>
</font><font style="color:rgba(25, 26, 31, 0.9);">王庶：《全国高速公路取消省界收费站项目落地实践》</font></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">王利康</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://wanglikang.github.io/2024/09/01/AnalyticDB%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">http://wanglikang.github.io/2024/09/01/AnalyticDB%20%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">王利康</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                    <span class="chip bg-color">中间件</span>
                                </a>
                            
                                <a href="/tags/NewSQL/">
                                    <span class="chip bg-color">NewSQL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="数据库基础知识">
                        
                        <span class="card-title">数据库基础知识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">
                                    中间件
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">中间件</span>
                    </a>
                    
                    <a href="/tags/NewSQL/">
                        <span class="chip bg-color">NewSQL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/09/01/AnalyticDB/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="AnalyticDB">
                        
                        <span class="card-title">AnalyticDB</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-09-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">
                                    中间件
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">中间件</span>
                    </a>
                    
                    <a href="/tags/NewSQL/">
                        <span class="chip bg-color">NewSQL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2024</span>
            
            <a href="/about" target="_blank">王利康</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/wanglikang" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1024196018@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1024196018" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1024196018" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    <!--腾讯兔小巢-->
    
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
